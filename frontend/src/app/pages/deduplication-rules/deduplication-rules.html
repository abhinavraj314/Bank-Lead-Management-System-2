<div class="deduplication-rules-page">
  <div class="page-header">
    <h1 class="page-title">Deduplication Rules</h1>
  </div>

  <!-- Info Banner -->
  <div class="info-banner">
    <span class="info-icon">‚ÑπÔ∏è</span>
    <p class="info-text">
      @if (isAdmin()) {
        Deduplication rules are defined per product. Select a product first to configure which
        canonical fields should be used to identify duplicate leads. Rules are saved permanently
        in the database. You can overwrite them anytime by selecting a product and saving new rules.
      } @else {
        Canonical fields used to identify duplicate leads across all products.
      }
    </p>
  </div>

  <!-- Saved rules for all products (Admin) -->
  @if (isAdmin() && products().length > 0) {
    <div class="content-card rules-overview-section">
      <h2 class="section-title">Saved Rules for All Products</h2>
      <p class="section-description">
        Deduplication fields configured per product. Empty means default (email, phone_number, aadhar_number).
      </p>
      <table class="rules-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Deduplication Fields</th>
          </tr>
        </thead>
        <tbody>
          @for (product of products(); track product.product_id) {
            <tr>
              <td>
                <strong>{{ product.product_name }}</strong>
                <span class="product-id-meta">({{ product.product_id }})</span>
              </td>
              <td>
                @if (product.deduplication_fields && product.deduplication_fields.length > 0) {
                  <span class="field-tags">
                    @for (f of product.deduplication_fields; track f) {
                      <span class="field-tag">{{ f }}</span>
                    }
                  </span>
                } @else {
                  <span class="default-text">Default (email, phone_number, aadhar_number)</span>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <div class="content-card">
    <!-- Admin View: Step 1 - Product Selection (to configure or overwrite rules) -->
    @if (isAdmin()) {
      <div class="section">
        <h2 class="section-title">Step 1: Select Product</h2>

        <div class="form-group">
          <label>Product <span class="required">*</span></label>
          <select
            [ngModel]="selectedProduct()"
            (ngModelChange)="onProductChanged($event)"
            class="product-select"
          >
            <option value="">-- Select a Product --</option>
            <option *ngFor="let product of products()" [value]="product.product_id">
              {{ product.product_name }}
            </option>
          </select>
        </div>

        @if (selectedProduct()) {
          <p class="product-selected">
            ‚úì Product selected: <strong>{{ getProductName(selectedProduct()) }}</strong>
          </p>
        }
      </div>

      <!-- Admin View: Step 2 - Canonical Fields Selection (only shown after product selection) -->
      @if (selectedProduct()) {
        <div class="section">
          <h2 class="section-title">Step 2: Select Canonical Fields for Deduplication</h2>
          <p class="section-description">
            Choose which fields should be compared to identify duplicate leads for this product.
            Leads are considered duplicates if all selected fields match.
          </p>

          @if (fields().length === 0) {
            <p class="empty-fields-message">
              No canonical fields available. Please create canonical fields first.
            </p>
          } @else {
            <div class="fields-list">
              <div class="field-item" *ngFor="let field of fields()">
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="isFieldSelected(field.field_name)"
                    (change)="toggleField(field.field_name)"
                  />
                  <span class="field-info">
                    <span class="field-name">{{ field.display_name }}</span>
                    <span class="field-meta">({{ field.field_name }} - {{ field.type }})</span>
                  </span>
                </label>
              </div>
            </div>

            @if (selectedFields().length > 0) {
              <p class="fields-selected">
                ‚úì <strong>{{ selectedFields().length }}</strong> field(s) selected for deduplication
              </p>
            }
          }
        </div>
      }
    } @else {
      <!-- User View: Just show canonical fields -->
      <div class="section">
        <h2 class="section-title">Canonical Fields</h2>
        <p class="section-description">
          These canonical fields are used to identify duplicate leads in the system.
        </p>

        @if (fields().length === 0) {
          <p class="empty-fields-message">No canonical fields available.</p>
        } @else {
          <div class="fields-list read-only">
            <div class="field-item" *ngFor="let field of fields()">
              <span class="field-info">
                <span class="field-name">{{ field.display_name }}</span>
                <span class="field-meta">({{ field.field_name }} - {{ field.type }})</span>
              </span>
            </div>
          </div>
          <p class="fields-info">
            <strong>Total:</strong> {{ fields().length }} canonical field(s)
          </p>
        }
      </div>
    }

    <!-- Error Message -->
    @if (errorMessage()) {
      <div class="error-message">
        <span class="error-icon">‚úï</span>
        {{ errorMessage() }}
      </div>
    }

    <!-- Success Message -->
    @if (successMessage()) {
      <div class="success-message">
        <span class="success-icon">‚úì</span>
        {{ successMessage() }}
      </div>
    }

    <!-- Actions (Admin Only) -->
    <div class="actions" *ngIf="isAdmin()">
      <button
        class="btn btn-primary"
        (click)="onSaveRules()"
        [disabled]="isSaving() || !selectedProduct()"
      >
        {{ isSaving() ? 'Saving...' : 'Save Deduplication Rules' }}
      </button>
      @if (selectedProduct()) {
        <button
          class="btn btn-secondary"
          (click)="onExecuteForProduct()"
          [disabled]="isExecuting()"
        >
          {{ isExecuting() ? 'Running...' : 'Run Deduplication for This Product' }}
        </button>
      }
      <button
        class="btn btn-secondary"
        (click)="onExecuteForAllProducts()"
        [disabled]="isExecuting()"
      >
        {{ isExecuting() ? 'Running...' : 'Run Deduplication for All Products' }}
      </button>
    </div>

    <!-- Info Banner: Auto-Deduplication -->
    <div class="info-banner info-banner-auto">
      <span class="info-icon">üîÑ</span>
      <p class="info-text">
        Deduplication runs automatically whenever leads are uploaded. Check the Upload Leads page
        for deduplication results and logs.
      </p>
    </div>
  </div>
</div>
